<form id="facturaForm" (ngSubmit)="onSubmit(facturaForm)" [formGroup]="facturaForm" (window:resize)="onResize($event)"
      novalidate>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12">
                <h2 class="dialog-subtitle">Datos del Cliente</h2>
                <div class="col-xs-12" [ngClass]="{'text-center': !isMobile}">
                    <button type="button" class="btn btn-primary btn-fill"
                            [ngClass]="{'btn-block': isMobile}"
                            (click)="openAddClientDialog()">
                        <i class="pe-7s-plus icon"></i>
                        <span>Cliente Nuevo</span>
                    </button>
                </div>

                <mat-form-field class="col-xs-12 full-width">
                    <input matInput placeholder="Selecciona un Cliente" aria-label="State" [matAutocomplete]="auto"
                           formControlName="cliente" required>
                    <mat-autocomplete #auto="matAutocomplete">
                        <mat-option *ngFor="let client of filteredClients | async" [value]="client.rfc">
                            <span>{{ client.rfc }}</span> |
                            <span>{{ client.razonsocial }}</span> |
                            <small>Email: {{client.email}}</small>
                        </mat-option>
                    </mat-autocomplete>
                    <mat-error *ngIf="facturaForm.controls['cliente'].hasError('required')">
                        El Cliente es <strong>requerido</strong>
                    </mat-error>
                    <mat-error *ngIf="facturaForm.controls['cliente'].hasError('clientDontExists')">
                        Ese Cliente <strong>NO EXISTE</strong>
                    </mat-error>
                </mat-form-field>
            </div>

            <div class="col-xs-12">
                <h2 class="dialog-subtitle">Forma de Pago</h2>
                <mat-form-field class="col-xs-12 col-sm-6 full-width">
                    <mat-select placeholder="Forma de Pago" formControlName="formadepago" required>
                        <mat-option *ngFor="let formadepago of formasdepago" [value]="formadepago">
                            {{formadepago}}
                        </mat-option>
                    </mat-select>
                    <mat-error *ngIf="facturaForm.controls['formadepago'].hasError('required')">
                        La Forma de Pago es <strong>requerida</strong>
                    </mat-error>
                </mat-form-field>
            </div>

            <div class="col-xs-12">
                <h2 class="dialog-subtitle">Conceptos</h2>
                <div formArrayName="conceptos">
                    <div class="col-xs-12 margin-bottom-25 concepto"
                         *ngFor="let concepto of facturaForm.get('conceptos').controls; let i=index">
                        <div [formGroupName]="i">
                            <div class="col-xs-12 col-sm-1">
                                <mat-form-field class="full-width">
                                    <input type="number" step="any" min="0" matInput placeholder="Cantidad"
                                           formControlName="cantidad" (change)="calcularImporte(i)" required>
                                    <mat-error *ngIf="concepto.get('cantidad').hasError('required')">
                                        La Cantidad es <strong>requerida</strong>
                                    </mat-error>
                                </mat-form-field>
                            </div>
                            <div class="col-xs-12 col-sm-2">
                                <mat-form-field class="full-width">
                                    <mat-select placeholder="Unidad" formControlName="unidad" required>
                                        <mat-option *ngFor="let unidad of unidades" [value]="unidad">
                                            {{unidad}}
                                        </mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="concepto.get('unidad').hasError('required')">
                                        La Unidad es <strong>requerida</strong>
                                    </mat-error>
                                </mat-form-field>
                            </div>
                            <div class="col-xs-12 col-sm-6">
                                <mat-form-field class="full-width">
                                    <input type="text" matInput placeholder="Descripción" formControlName="descripcion"
                                           required>
                                    <mat-error *ngIf="concepto.get('descripcion').hasError('required')">
                                        La Descripción es <strong>requerida</strong>
                                    </mat-error>
                                </mat-form-field>
                            </div>
                            <div class="col-xs-12 col-sm-1">
                                <mat-form-field class="full-width">
                                    <input type="number" step="any" min="0" matInput placeholder="Valor Unitario"
                                           formControlName="valorunitario" (change)="calcularImporte(i)" required>
                                    <mat-error *ngIf="concepto.get('valorunitario').hasError('required')">
                                        El Valor Unitario es <strong>requerido</strong>
                                    </mat-error>
                                </mat-form-field>
                            </div>
                            <div class="col-xs-12 col-sm-1">
                                <mat-form-field class="full-width">
                                    <input type="number" step="any" min="0" matInput placeholder="Importe"
                                           formControlName="importe" readonly>
                                </mat-form-field>
                            </div>
                            <div class="col-xs-12 col-sm-1">
                                <button *ngIf="i != 0 || (facturaForm.get('conceptos').controls.length) > 1"
                                        type="button" class="btn btn-danger btn-fill btn-block"
                                        (click)="removeConcepto(i)">
                                    <i class="pe-7s-close-circle icon"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12" [ngClass]="{'text-center': !isMobile}">
                    <button type="button" class="btn btn-primary btn-fill"
                            [ngClass]="{'btn-block': isMobile}"
                            (click)="addConcepto()">
                        <i class="pe-7s-plus icon"></i>
                        <span>Otro Concepto</span>
                    </button>
                </div>
            </div>

            <div class="col-xs-12">
                <h2 class="dialog-subtitle">Totales</h2>
                <mat-form-field class="full-width">
                    <input type="number" step="any" min="0" matInput placeholder="Sub-Total" formControlName="subtotal"
                           readonly>
                </mat-form-field>
                <mat-form-field class="full-width">
                    <input type="number" step="any" min="0" matInput placeholder="I.V.A." formControlName="iva"
                           readonly>
                </mat-form-field>
                <mat-form-field class="full-width">
                    <input type="number" step="any" min="0" matInput placeholder="Total Neto"
                           formControlName="totalneto" readonly>
                </mat-form-field>
            </div>

            <div class="col-xs-12" [ngClass]="{'text-center': !isMobile}">
                <button type="submit" form="facturaForm" class="btn btn-success btn-fill"
                        [ngClass]="{'btn-block': isMobile}" [disabled]="facturaForm.invalid">
                    <i class="pe-7s-upload icon"></i>
                    <span>Enviar Factura</span>
                </button>
            </div>
        </div>
    </div>
</form>
